<html>
	<head>
		<title>Javascript Bluetooth Print</title>
	</head>

	<body style="background-color: #999">
		<div>
			<image id="img_logo" src="logo-fgta-mono.png" width="300px" height="80px"></image>
		</div>
		<br><br><br>
		<button id="btn_print" style="width: 100px; height: 50px;" >print</button>
		<button id="btn_cekusb" style="width: 100px; height: 50px;" >cek usb</button>
	</body>






	<script>

		function getDarkPixel(canvas, imageData, x, y) {
			// Return the pixels that will be printed black
			let red = imageData[((canvas.width * y) + x) * 4];
			let green = imageData[((canvas.width * y) + x) * 4 + 1];
			let blue = imageData[((canvas.width * y) + x) * 4 + 2];
			return (red + green + blue) > 0 ? 1 : 0;
		}

		function getImagePrintData(id) {

			var image = document.getElementById(id);
			// var canvas = document.createElement('canvas');
			var realWidth = image.naturalWidth;
        	var realHeight = image.naturalHeight;

			var canvas = document.createElement('canvas');

			canvas.width = 360;
			canvas.height = 120;

			var context = canvas.getContext("2d");
			context.drawImage(image, 0, 0, canvas.width, canvas.height);

			try {
				var imageData = context.getImageData(0, 0, canvas.width, canvas.height).data;
				if (imageData == null) {
					throw new Error('No image to print!');
				}

				var printData = new Uint8Array(canvas.width / 8 * canvas.height + 8);
         		var offset = 0;


				printData[0] = 29;  // Print raster bitmap
				printData[1] = 118; // Print raster bitmap
				printData[2] = 48; // Print raster bitmap
				printData[3] = 0;  // Normal 203.2 DPI
				printData[4] = canvas.width / 8; // Number of horizontal data bits (LSB)
				printData[5] = 0; // Number of horizontal data bits (MSB)
				printData[6] = canvas.height % 256; // Number of vertical data bits (LSB)
				printData[7] = canvas.height / 256;  // Number of vertical data bits (MSB)
				offset = 7;
				
				// Loop through image rows in bytes
				for (let i = 0; i < canvas.height; ++i) {
					for (let k = 0; k < canvas.width / 8; ++k) {
						let k8 = k * 8;
						//  Pixel to bit position mapping
						printData[++offset] = getDarkPixel(canvas, imageData, k8 + 0, i) * 128 + getDarkPixel(canvas, imageData, k8 + 1, i) * 64 +
									getDarkPixel(canvas, imageData, k8 + 2, i) * 32 + getDarkPixel(canvas, imageData, k8 + 3, i) * 16 +
									getDarkPixel(canvas, imageData, k8 + 4, i) * 8 + getDarkPixel(canvas, imageData, k8 + 5, i) * 4 +
									getDarkPixel(canvas, imageData, k8 + 6, i) * 2 + getDarkPixel(canvas, imageData, k8 + 7, i);
					}
				}

				return printData;

			} catch (err) {
				throw err;
			}
		}

        function sendNextImageDataBatch(printCharacteristic, data, index, resolve, reject) {
			// Can only write 512 bytes at a time to the characteristic
			// Need to send the image data in 512 byte batches
			if (index + 512 < data.length) {
				var datatoprint = data.slice(index, index + 512);
				printCharacteristic.writeValue(datatoprint).then(() => {
					index += 512;
					sendNextImageDataBatch(printCharacteristic, data, index, resolve, reject);
				})
				.catch(error => reject(error));
			} else {
				// Send the last bytes
				if (index < data.length) {
					printCharacteristic.writeValue(data.slice(index, data.length)).then(() => {
					resolve();
					})
					.catch(error => reject(error));
				} else {
					resolve();
				}
			}
        }


		async function sendImageData(printCharacteristic, image_id) {
			var index = 0;
			var data = getImagePrintData(image_id);
			return new Promise(function(resolve, reject) {
				sendNextImageDataBatch(printCharacteristic, data, index, resolve, reject);
			});
		}

	</script>


	<script>
		var btn_print = document.getElementById('btn_print');
		btn_print.addEventListener('click', async function () {

			try {

				
				console.log('selecting device');
				var device = await navigator.bluetooth.requestDevice({
					filters: [{
						services: ['000018f0-0000-1000-8000-00805f9b34fb']
					}]
				})
				console.log('> Found ' + device.name);


				console.log('Connecting to GATT Server...');
				var server = await device.gatt.connect()
				console.log('connected');

				var service = await server.getPrimaryService("000018f0-0000-1000-8000-00805f9b34fb");
				var printCharacteristic = await service.getCharacteristic("00002af1-0000-1000-8000-00805f9b34fb");

	

				
				if (printCharacteristic!=null) {
					
					// Test Print Text
					var text = "Halo Printer...";
					var encoder = new TextEncoder("utf-8");
					var line = encoder.encode(text + '\u000A\u000D');
					await printCharacteristic.writeValue(line);


					// Test Print Image
					await sendImageData(printCharacteristic, "img_logo");
					await printCharacteristic.writeValue(encoder.encode(" " + '\u000A\u000D'));
					await printCharacteristic.writeValue(encoder.encode(" " + '\u000A\u000D'));
					await printCharacteristic.writeValue(encoder.encode(" " + '\u000A\u000D'));
					await printCharacteristic.writeValue(encoder.encode(" " + '\u000A\u000D'));
					await printCharacteristic.writeValue(encoder.encode(" " + '\u000A\u000D'));
					await printCharacteristic.writeValue(encoder.encode(" " + '\u000A\u000D'));
					await printCharacteristic.writeValue(encoder.encode(" " + '\u000A\u000D'));
					await printCharacteristic.writeValue(encoder.encode(" " + '\u000A\u000D'));
					await printCharacteristic.writeValue(encoder.encode(" " + '\u000A\u000D'));
					await printCharacteristic.writeValue(encoder.encode(" " + '\u000A\u000D'));
					await printCharacteristic.writeValue(encoder.encode(" " + '\u000A\u000D'));
					await printCharacteristic.writeValue(encoder.encode(" " + '\u000A\u000D'));
					await printCharacteristic.writeValue(encoder.encode(" " + '\u000A\u000D'));
					await printCharacteristic.writeValue(encoder.encode(" " + '\u000A\u000D'));
					await printCharacteristic.writeValue(encoder.encode(" " + '\u000A\u000D'));
	


				} else {
					throw new Error('Cannot get printCharacteristic');
				}

				
				


			} catch (err) {
				console.log(err);
			}

		});
	
	</script>

	<script>
		var usbPrinter = null;
		var btn_cekusb = document.getElementById('btn_cekusb');
		btn_cekusb.addEventListener('click', async function () {

			if (usbPrinter==null) {
				usbPrinter = await navigator.usb.requestDevice({filters:[]});
			}

			await usbPrinter.open();
            await usbPrinter.selectConfiguration(1);
			

			console.log( usbPrinter.configuration.interfaces[0].interfaceNumber)
			console.log(usbPrinter.configuration.interfaces);
			await usbPrinter.claimInterface(0);
			// usbPrinter.claimInterface(
            //     usbPrinter.configuration.interfaces[0].interfaceNumber
            // );


		});	

	</script>


</html>


